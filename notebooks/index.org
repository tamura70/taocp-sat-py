#+TITLE: Knuth先生の『TAOCP 7.2.2.2 Satisfiability』を読む
#+AUTHOR: 田村直之

* はじめに
Donald E. Knuth 先生の名著 [[https://www-cs-faculty.stanford.edu/~knuth/taocp.html][The Art of Computer Programming]] (TAOCP)の
第4巻 Combinatorial Algorithms 中の 7.2.2.2 節 Satisfiability のプログラム等を提供している．
プログラムは [[https://mybinder.org][Binder]] あるいは [[https://colab.research.google.com][Google Colaboratory]] 上の [[http://jupyter.org][Jupyter]] ノートブックで実行可能である．

内容の補足については，以下を参照．

  - [[http://bach.istc.kobe-u.ac.jp/lect/taocp-sat/][Knuth先生の『TAOCP 7.2.2.2 Satisfiability』を読む]]

* プログラム

Knuth作のSATソルバーや関連するプログラムは以下から入手可能である．
  - [[https://www-cs-faculty.stanford.edu/~knuth/programs.html]]

ここでは，以下のWebページの方法でコンパイルしている．
  - [[http://bach.istc.kobe-u.ac.jp/lect/taocp-sat/install-knuth.html][Knuth版SATソルバーのインストール]]

** Binder上で実行する場合の注意点

- アカウントは不要．
- プログラムはすでにインストールされている．
- 20分程度操作をしないとセッションが停止するが12時間程度は設定が残っている．
  - つまり，12時間程度はノートブックに対するコンテナが残っている．
- セッションが停止すると自分が編集した内容は失われる．
  - 必要ならノートブック名を右クリックして自分のPCにDownloadしておく．

新しいセッションを開始するときは必ず以下を実行し prog フォルダに移動する．

#+BEGIN_SRC ipython
cd ~/prog
#+END_SRC

** Google Colab上で実行する場合の注意点

- Googleアカウントが必要．
- プログラムのインストール作業が必要．
- 60分程度操作をしないとセッションが停止するが12時間程度は設定が残っている．
  - つまり，12時間程度はノートブックに対するコンテナが残っている．
  - ウィンドウ左側の「ファイル」でインストールしたファイルが残っていることを確認するとよい．残っていなければインストール作業を行う．
- ノートブックをGoogle Driveに保存することが可能．
  - まず最初に「ドライブにコピー」を実行するのがよい．

新しいセッションを開始するときは必ず以下を実行しプログラムをインストールする．

#+BEGIN_SRC ipython
%%bash
cd /content
wget -nc https://raw.githubusercontent.com/tamura70/taocp-sat-py/master/colab/setup.sh
sh setup.sh
#+END_SRC

また，以下を実行し prog フォルダに移動する．

#+BEGIN_SRC ipython
cd /content/prog
#+END_SRC

* 充足可能性

教科書4ページの式(6) [[../prog/rivest-sat.sat][rivest-sat.sat]] に対してKnuth作のSATソルバー sat13 を実行してみる．
#+BEGIN_SRC ipython
! sat13 < rivest-unsat.sat
#+END_SRC

以下のような出力結果が得られるはずだ．
#+BEGIN_EXAMPLE
(4 variables, 8 clauses, 24 literals successfully read)
UNSAT
Altogether 301+670 mems, 5804 bytes, 3 nodes, 3 clauses learned (ave 1.3->1.3), 60 memcells.
(2 clauses were subsumed on-the-fly.)
(1 restart.)
~
#+END_EXAMPLE

  - 充足不能を表す "=~=" の行は標準出力に，その他はピンク色の背景の標準エラーに出力されている．
    標準出力と標準エラー出力の順序は前後することがある．
  - 出力中の最初の行は，入力中の変数の個数，節の個数，リテラルの個数を表している．
  - "=301+670 mems=" は，メモリーアクセス回数を表す．
    =301= が前処理でのアクセス数， =670= が解探索でのアクセス数である．
  - "=5804 bytes=" は，メモリー使用量を表す．
  - "=3 nodes=" は，解探索で暗黙的に作成された探索木のノード数を表す．
  - "=3 clauses learned=" は，学習節の個数を表す．
  - その他については，sat13.pdf中の説明や教科書中の説明を参照すること．

次に，教科書4ページの式(7) [[../prog/rivest-sat.sat][rivest-sat.sat]] に対しても同様に実行してみる．
#+BEGIN_SRC ipython
! sat13 < rivest-sat.sat
#+END_SRC

  - 解の値割当てを表す "=3 ~1 2 4=" 以外の行は，標準エラーに出力されている．

各プログラムの詳細は，それぞれのPDFファイルを参照すること．
例えば [[../knuth/pdf/sat13.pdf][sat13.pdf]] には以下の説明がある．
  - 1ページ: 入力の形式
    + 変数名はASCIIコードで "=!=" から "=}=" の間 (つまり16進で22から7Cまで)の8文字以内の文字列で，
      "=~=" から始まらないもの
    + 変数名の直前に "=~=" を付けると否定を表す
    + "@<tt>~ @</tt>" から始まる行はコメント
  - 3ページ: オプションの説明
    + [[../knuth/sat-examples/README][knuth/sat-examples/README]] によれば，Knuthは以下のオプション指定を用いている．
      : $ sat13 h14 b10000 T50000000000 <file.sat

Scala版のプログラムを利用する場合は以下のようになる．
#+BEGIN_SRC ipython
! ./taocpsat SolverA < rivest-sat.sat
#+END_SRC

* 簡単な例 (A simple example)

$\textit{waerden}(3,3;9)$ が充足不能 (unsat)であることを，
入力ファイル [[../prog/waerden-3-3-9.sat][waerden-3-3-9.sat]] を用いて確かめる．
#+BEGIN_SRC ipython
! sat13 < waerden-3-3-9.sat
#+END_SRC

$\textit{waerden}(j,k;n)$ のCNF式を出力するプログラムは [[../knuth/pdf/sat-waerden.pdf][sat-waerden]] である．
#+BEGIN_SRC ipython
! sat-waerden 3 3 8
#+END_SRC

bashのパイプ (~|~)を用いて，以下のようにすれば sat13 の入力として与えることができる．
#+BEGIN_SRC ipython
! sat-waerden 3 3 8 | sat13
#+END_SRC

Scala版のプログラムを利用する場合は以下のようになる．
#+BEGIN_SRC ipython
! ./taocpsat waerden 3 3 8 | sat13
#+END_SRC

* 厳密被覆 (Exact covering)

$\textit{langford}(n)$ の厳密被覆問題を出力するプログラムは [[../knuth/pdf/langford.pdf][langford]] である．
#+BEGIN_SRC ipython
! langford 3
#+END_SRC

これをCNF式に変換して sat13 の入力として与えるには以下のようにする．
#+BEGIN_SRC ipython
! langford 3 | sat-dance | sat13
#+END_SRC

結果から2, 7, 8のオプション，すなわち"d1 s2 s4", "d2 s3 s6", "d3 s1 s5"が選ばれていることがわかる．
これから解 "312132" が得られる．

$\textit{langford}'(n)$ の場合は以下のように実行する．
#+BEGIN_SRC ipython
! langford 3 | sat-dance-heule | sat13
#+END_SRC

* グラフ彩色 (Coloring a graph)

10次のMcGregorグラフを4彩色するには以下のようにする．
#+BEGIN_SRC ipython
! mcgregor-graph 10
! sat-color mcgregor10.gb 4 | sat13
#+END_SRC

結果を取り出すには以下のようにすれば良い．
#+BEGIN_SRC ipython
! mcgregor-graph 10
! sat-color mcgregor10.gb 4 | sat13 | tr " " "\n" | grep -v '^~' | sort -n
#+END_SRC

10次のMcGregorグラフの4彩色で色1が7回以下の彩色を求める．
#+BEGIN_SRC ipython
! mcgregor-graph 10
! sat-color mcgregor10.gb 4 > /tmp/mcg10.sat
! sat-threshold-sinz-graphs 110 7 mcgregor10.gb 1 > /tmp/mcg10le7.sat
! cat /tmp/mcg10.sat /tmp/mcg10le7.sat | sat13 | tr " " "\n" | grep -v '^[~S]' | grep '\.1$'
#+END_SRC


